<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>√âditeur HTML</title>

  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/xml/xml.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/selection/active-line.min.js"></script>

  <style>
    :root{
      /* Dark (default) UI */
      --ui-bg:#0b1220;
      --ui-text:#e7eefc;
      --ui-muted:#a8b3c7;
      --ui-border:rgba(255,255,255,.12);
      --ui-shadow:0 10px 30px rgba(0,0,0,.35);
      --ui-btn:#1b2c54;
      --ui-btnHover:#233868;

      /* Dark editor palette */
      --cm-bg:#182028;
      --cm-gutter:#121a21;
      --cm-caret:#e7eefc;
      --cm-text:#d0d0d0;

      --cm-tag:#ea365a;
      --cm-attr:#b0d870;
      --cm-string:#e3af4f;
      --cm-keyword:#b078e0;
      --cm-number:#f3c56b;
      --cm-prop:#b078e0;
      --cm-comment:#6f7f8b;
      --cm-operator:#cbd5e1;

      --cm-activeLine:rgba(34,48,58,.55);
      --cm-select:rgba(110,168,254,.30);

      --search-highlight: rgba(255,209,102,.85);
      --search-current: rgba(110,168,254,.95);
    }

    [data-theme="light"]{
      --ui-bg:#f5f7fb;
      --ui-text:#0f172a;
      --ui-muted:#475569;
      --ui-border:rgba(15,23,42,.12);
      --ui-shadow:0 10px 30px rgba(15,23,42,.12);
      --ui-btn:#e8eefc;
      --ui-btnHover:#dbe6ff;

      --cm-bg:#ffffff;
      --cm-gutter:#f1f5f9;
      --cm-caret:#0f172a;
      --cm-text:#0f172a;

      --cm-tag:#d61f45;
      --cm-attr:#2f7d1e;
      --cm-string:#b45309;
      --cm-keyword:#6d28d9;
      --cm-number:#b45309;
      --cm-prop:#6d28d9;
      --cm-comment:#64748b;
      --cm-operator:#334155;

      --cm-activeLine:rgba(148,163,184,.22);
      --cm-select:rgba(59,130,246,.22);

      --search-highlight: rgba(255,209,102,.55);
      --search-current: rgba(59,130,246,.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(110,168,254,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 0%, rgba(43,213,118,.10), transparent 55%),
        var(--ui-bg);
      color:var(--ui-text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      padding:18px;
    }

    [data-theme="light"] body{
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(59,130,246,.10), transparent 60%),
        radial-gradient(900px 700px at 80% 0%, rgba(34,197,94,.08), transparent 55%),
        var(--ui-bg);
    }

    .container{
      width:100%;
      max-width:1200px;
      margin:0 auto;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .hint{ font-size:12px; color:var(--ui-muted); text-align:right; line-height:1.3; }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding:12px;
      border:1px solid var(--ui-border);
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--ui-shadow);
      margin-bottom:10px;
      backdrop-filter: blur(6px);
    }
    [data-theme="light"] .toolbar{
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.72));
    }

    .btn{
      appearance:none;
      border:1px solid var(--ui-border);
      background:var(--ui-btn);
      color:var(--ui-text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:13px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background:var(--ui-btnHover); border-color: rgba(255,255,255,.18); }
    [data-theme="light"] .btn:hover{ border-color: rgba(15,23,42,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background:transparent; }

    .btn.ok{ background: rgba(43,213,118,.16); border-color: rgba(43,213,118,.28); }
    .btn.ok:hover{ background: rgba(43,213,118,.22); }

    .btn.danger{ background: rgba(255,107,107,.16); border-color: rgba(255,107,107,.28); }
    .btn.danger:hover{ background: rgba(255,107,107,.22); }

    .spacer{ flex:1 1 auto; }

    .searchbar{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1 1 520px;
      min-width:260px;
      padding:10px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--ui-border);
    }
    [data-theme="light"] .searchbar{
      background: rgba(15,23,42,.04);
    }
    .searchbar input{
      flex:1;
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--ui-text);
      font-size:13px;
    }
    .count{
      font-size:12px;
      color:var(--ui-muted);
      white-space:nowrap;
      padding-right:4px;
      min-width:54px;
      text-align:right;
    }

    .status{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--ui-border);
      border-radius:999px;
      background: rgba(255,255,255,.06);
      color:var(--ui-muted);
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    [data-theme="light"] .status{
      background: rgba(15,23,42,.04);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,209,102,.95);
    }
    .status.saved .dot{ background: rgba(43,213,118,.95); }
    .status strong{ color:var(--ui-text); font-weight:700; }

    .editorCard{
      border:1px solid var(--ui-border);
      border-radius:16px;
      overflow:hidden;
      box-shadow: var(--ui-shadow);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }
    [data-theme="light"] .editorCard{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.82));
    }

    .editorHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 12px;
      border-bottom:1px solid var(--ui-border);
      background: rgba(0,0,0,.16);
      color:var(--ui-muted);
      font-size:12px;
    }
    [data-theme="light"] .editorHeader{
      background: rgba(15,23,42,.04);
    }

    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      padding:6px 10px;
      border:1px solid var(--ui-border);
      border-radius:999px;
      background: rgba(255,255,255,.06);
    }
    [data-theme="light"] .badge{
      background: rgba(15,23,42,.04);
    }
    .badge strong{ color:var(--ui-text); }

    .cm-s-captureLike.CodeMirror,
    .cm-s-captureLight.CodeMirror{
      height: 64vh;
      border:none;
      background: var(--cm-bg);
      color: var(--cm-text);
      font-size: 13px;
      line-height: 1.55;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .cm-s-captureLike .CodeMirror-scroll,
    .cm-s-captureLight .CodeMirror-scroll{ padding: 10px 0; }

    .cm-s-captureLike .CodeMirror-gutters,
    .cm-s-captureLight .CodeMirror-gutters{
      background: var(--cm-gutter);
      border-right: 1px solid rgba(255,255,255,.10);
    }
    [data-theme="light"] .cm-s-captureLight .CodeMirror-gutters{
      border-right: 1px solid rgba(15,23,42,.10);
    }

    .cm-s-captureLike .CodeMirror-linenumber,
    .cm-s-captureLight .CodeMirror-linenumber{
      color: rgba(168,179,199,.70);
    }
    [data-theme="light"] .cm-s-captureLight .CodeMirror-linenumber{
      color: rgba(71,85,105,.85);
    }

    .cm-s-captureLike .CodeMirror-cursor,
    .cm-s-captureLight .CodeMirror-cursor{
      border-left: 2px solid var(--cm-caret);
    }

    .cm-s-captureLike .CodeMirror-activeline-background,
    .cm-s-captureLight .CodeMirror-activeline-background{
      background: var(--cm-activeLine);
    }

    .cm-s-captureLike .CodeMirror-selected,
    .cm-s-captureLike .CodeMirror-line::selection,
    .cm-s-captureLike .CodeMirror-line > span::selection,
    .cm-s-captureLike .CodeMirror-line > span > span::selection,
    .cm-s-captureLight .CodeMirror-selected,
    .cm-s-captureLight .CodeMirror-line::selection,
    .cm-s-captureLight .CodeMirror-line > span::selection,
    .cm-s-captureLight .CodeMirror-line > span > span::selection{
      background: var(--cm-select);
    }

    .cm-s-captureLike span.cm-tag,
    .cm-s-captureLight span.cm-tag{ color: var(--cm-tag); }
    .cm-s-captureLike span.cm-bracket,
    .cm-s-captureLight span.cm-bracket{ color: var(--cm-tag); }
    .cm-s-captureLike span.cm-attribute,
    .cm-s-captureLight span.cm-attribute{ color: var(--cm-attr); }
    .cm-s-captureLike span.cm-string,
    .cm-s-captureLight span.cm-string{ color: var(--cm-string); }
    .cm-s-captureLike span.cm-string-2,
    .cm-s-captureLight span.cm-string-2{ color: var(--cm-string); }

    .cm-s-captureLike span.cm-keyword,
    .cm-s-captureLight span.cm-keyword{ color: var(--cm-keyword); }
    .cm-s-captureLike span.cm-def,
    .cm-s-captureLight span.cm-def{ color: var(--cm-string); }

    .cm-s-captureLike span.cm-variable,
    .cm-s-captureLight span.cm-variable{ color: var(--cm-text); }
    .cm-s-captureLike span.cm-variable-2,
    .cm-s-captureLight span.cm-variable-2{ color: var(--cm-text); }
    .cm-s-captureLike span.cm-variable-3,
    .cm-s-captureLight span.cm-variable-3{ color: var(--cm-text); }

    .cm-s-captureLike span.cm-property,
    .cm-s-captureLight span.cm-property{ color: var(--cm-prop); }
    .cm-s-captureLike span.cm-qualifier,
    .cm-s-captureLight span.cm-qualifier{ color: var(--cm-attr); }
    .cm-s-captureLike span.cm-atom,
    .cm-s-captureLight span.cm-atom{ color: var(--cm-keyword); }

    .cm-s-captureLike span.cm-number,
    .cm-s-captureLight span.cm-number{ color: var(--cm-number); }
    .cm-s-captureLike span.cm-comment,
    .cm-s-captureLight span.cm-comment{ color: var(--cm-comment); font-style: italic; }
    .cm-s-captureLike span.cm-operator,
    .cm-s-captureLight span.cm-operator{ color: var(--cm-operator); }
    .cm-s-captureLike span.cm-meta,
    .cm-s-captureLight span.cm-meta{ color: var(--cm-number); }

    .cm-find-highlight{ background: var(--search-highlight); color:#000; font-weight:700; }
    .cm-find-current{ background: var(--search-current); color:#000; font-weight:800; }
    [data-theme="light"] .cm-find-highlight,
    [data-theme="light"] .cm-find-current{
      color: var(--ui-text);
    }

    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding:12px;
      margin-top:10px;
      border:1px solid var(--ui-border);
      border-radius:14px;
      background: rgba(255,255,255,.04);
      box-shadow: var(--ui-shadow);
    }
    [data-theme="light"] .footer{
      background: rgba(255,255,255,.85);
    }
    .footer .note{
      font-size:12px;
      color:var(--ui-muted);
    }

    #fileInput{ display:none; }

    @media (max-width: 640px){
      header{ flex-direction:column; align-items:flex-start; }
      .hint{ text-align:left; }
      .cm-s-captureLike.CodeMirror,
      .cm-s-captureLight.CodeMirror{ height:62vh; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>√âditeur HTML</h1>
      <div class="hint">
        Recherche: <b>Entr√©e</b> suivant - <b>Shift+Entr√©e</b> pr√©c√©dent
      </div>
    </header>

    <div class="toolbar">
      <button class="btn" id="openFile" type="button">üìÇ Ouvrir un fichier</button>
      <input id="fileInput" type="file" accept=".html,.htm,.txt,.js,.css,text/*" />

      <div class="searchbar" role="search">
        <input type="text" id="searchInput" placeholder="Rechercher un terme..." autocomplete="off" />
        <div class="count" id="count">0 / 0</div>
        <button class="btn secondary" id="prevBtn" type="button" title="Occurence pr√©c√©dente">‚¨ÜÔ∏è</button>
        <button class="btn secondary" id="nextBtn" type="button" title="Occurence suivante">‚¨áÔ∏è</button>
      </div>

      <button class="btn secondary" id="themeBtn" type="button" title="Basculer le th√®me">üåì Th√®me</button>

      <div class="spacer"></div>

      <div class="status" id="status">
        <span class="dot"></span>
        <strong id="statusLabel">Non sauvegard√©</strong>
      </div>
    </div>

    <div class="editorCard">
      <div class="editorHeader">
        <div class="badges">
          <div class="badge" id="fileBadge">Fichier - <strong>(aucun)</strong></div>
          <div class="badge">Lignes - <strong id="lineCount">0</strong></div>
          <div class="badge">Caract√®res - <strong id="charCount">0</strong></div>
        </div>
        <div id="persistNote">Restauration - aucune</div>
      </div>

      <textarea id="codeEditor"></textarea>
    </div>

    <div class="footer">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn ok" id="save" type="button">üíæ Enregistrer</button>
        <button class="btn" id="execute" type="button">‚ñ∂Ô∏è Ex√©cuter</button>
        <button class="btn danger" id="reset" type="button">üßπ R√©initialiser</button>
      </div>
      <div class="note">Le code est stock√© en cookies et restaur√© automatiquement.</div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Theme persistence
    // ----------------------------
    const THEME_KEY = "html_editor_theme"; // "dark" | "light"

    function setCookie(name, value, days){
      const maxAge = days ? ("; max-age=" + String(days * 24 * 60 * 60)) : "";
      document.cookie = name + "=" + encodeURIComponent(value) + maxAge + "; path=/; samesite=lax";
    }
    function getCookie(name){
      const parts = document.cookie.split(";").map(s => s.trim());
      for(const p of parts){
        if(p.startsWith(name + "=")) return decodeURIComponent(p.slice(name.length + 1));
      }
      return "";
    }

    function getSavedTheme(){
      const ls = localStorage.getItem(THEME_KEY);
      if(ls === "dark" || ls === "light") return ls;

      const ck = getCookie(THEME_KEY);
      if(ck === "dark" || ck === "light") return ck;

      return "dark";
    }

    function applyTheme(mode){
      const root = document.documentElement;
      if(mode === "light") root.setAttribute("data-theme", "light");
      else root.removeAttribute("data-theme");

      localStorage.setItem(THEME_KEY, mode);
      setCookie(THEME_KEY, mode, 365);

      if(window.editor){
        editor.setOption("theme", mode === "light" ? "captureLight" : "captureLike");
        editor.refresh();
      }
    }

    function toggleTheme(){
      const current = getSavedTheme();
      applyTheme(current === "light" ? "dark" : "light");
    }

    applyTheme(getSavedTheme());

    // ----------------------------
    // Storage (content)
    // ----------------------------
    const KEY_SESSION  = "html_editor_cm5_session_capture";
    const KEY_LOCAL    = "html_editor_cm5_local_capture";
    const KEY_FILENAME = "html_editor_cm5_filename_capture";

    // UI
    const statusEl = document.getElementById("status");
    const statusLabel = document.getElementById("statusLabel");
    const fileBadge = document.getElementById("fileBadge");
    const persistNote = document.getElementById("persistNote");
    const lineCount = document.getElementById("lineCount");
    const charCount = document.getElementById("charCount");

    const searchInput = document.getElementById("searchInput");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const countEl = document.getElementById("count");

    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setSaved(saved){
      if(saved){
        statusEl.classList.add("saved");
        statusLabel.textContent = "Enregistr√©";
      }else{
        statusEl.classList.remove("saved");
        statusLabel.textContent = "Non enregistr√©";
      }
    }

    function updateStats(){
      const text = editor.getValue();
      charCount.textContent = String(text.length);
      lineCount.textContent = String(editor.lineCount());
    }

    function persist(text){
      sessionStorage.setItem(KEY_SESSION, text);
      localStorage.setItem(KEY_LOCAL, text);
      setSaved(true);
    }

    function clearPersist(){
      sessionStorage.removeItem(KEY_SESSION);
      localStorage.removeItem(KEY_LOCAL);
      localStorage.removeItem(KEY_FILENAME);
      setSaved(false);
    }

    function restore(){
      const s = sessionStorage.getItem(KEY_SESSION);
      const l = localStorage.getItem(KEY_LOCAL);
      if(s && s.length) return { text: s, source: "session" };
      if(l && l.length) return { text: l, source: "local" };
      return { text: "", source: "" };
    }

    // ----------------------------
    // CodeMirror init
    // ----------------------------
    window.editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
      mode: "htmlmixed",
      theme: "captureLike",
      lineNumbers: true,
      styleActiveLine: true,
      autoCloseTags: true,
      matchBrackets: true,
      indentUnit: 2,
      tabSize: 2
    });

    editor.setOption("extraKeys", {
      Tab: (cm) => cm.replaceSelection("  ", "end"),
      "Shift-Tab": (cm) => cm.execCommand("indentLess")
    });

    applyTheme(getSavedTheme());
    document.getElementById("themeBtn").addEventListener("click", toggleTheme);

    // Restore content + filename
    (function initRestore(){
      const r = restore();
      if(r.text){
        editor.setValue(r.text);
        persistNote.textContent = "Restauration - " + r.source;
        setSaved(true);
      }else{
        persistNote.textContent = "Restauration - aucune";
        setSaved(false);
      }

      const fname = localStorage.getItem(KEY_FILENAME);
      if(fname){
        fileBadge.innerHTML = "Fichier - <strong>" + escapeHTML(fname) + "</strong>";
      }

      updateStats();
    })();

    // Autosave debounce
    let t = null;

    // ----------------------------
    // Search state
    // ----------------------------
    let marks = [];
    let matchRanges = [];   // [{from,to,startIndex,endIndex}]
    let currentMatch = -1;

    function clearHighlights(){
      for(const m of marks) m.clear();
      marks = [];
      matchRanges = [];
    }

    function updateCounter(){
      const total = matchRanges.length;
      const cur = (total && currentMatch >= 0) ? (currentMatch + 1) : 0;
      countEl.textContent = cur + " / " + total;
    }

    function findBestMatchIndex(anchorIndex){
      if(!matchRanges.length) return -1;

      // 1) If cursor is inside a match: keep that exact match
      for(let i=0;i<matchRanges.length;i++){
        const m = matchRanges[i];
        if(anchorIndex >= m.startIndex && anchorIndex <= m.endIndex) return i;
      }

      // 2) Otherwise keep the nearest previous match (so we don't jump forward)
      let prev = -1;
      for(let i=0;i<matchRanges.length;i++){
        if(matchRanges[i].startIndex <= anchorIndex) prev = i;
        else break;
      }
      if(prev !== -1) return prev;

      // 3) Fallback: first match
      return 0;
    }

    function buildRanges(term){
      const content = editor.getValue();
      const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const re = new RegExp(escaped, "gi");

      const ranges = [];
      let m;
      while((m = re.exec(content)) !== null){
        const start = m.index;
        const end = start + m[0].length;
        const from = editor.posFromIndex(start);
        const to = editor.posFromIndex(end);
        ranges.push({ from, to, startIndex: start, endIndex: end });
      }
      return ranges;
    }

    function paintMarks(scrollToCurrent){
      const term = (searchInput.value || "").trim();
      if(!term || !matchRanges.length) return;

      // rebuild marks with "current" distinct
      for(const m of marks) m.clear();
      marks = [];

      for(let i=0;i<matchRanges.length;i++){
        const r = matchRanges[i];
        const cls = (i === currentMatch) ? "cm-find-current" : "cm-find-highlight";
        marks.push(editor.markText(r.from, r.to, { className: cls }));
      }

      if(scrollToCurrent && currentMatch >= 0){
        editor.scrollIntoView(matchRanges[currentMatch].from, 80);
      }
    }

    /**
     * refreshSearch
     * - keepIndex: keeps currentMatch as much as possible
     * - anchorIndex: if provided, currentMatch is chosen to stay on the match containing/nearest-before the cursor
     * - scroll: only scroll when navigation happens (not when typing)
     */
    function refreshSearch({ keepIndex=false, anchorIndex=null, scroll=false } = {}){
      const term = (searchInput.value || "").trim();

      // keep the current cursor (we don't change it anyway, but we use its index to anchor)
      const effectiveAnchor = (anchorIndex === null)
        ? editor.indexFromPos(editor.getCursor())
        : anchorIndex;

      clearHighlights();

      if(!term){
        currentMatch = -1;
        updateCounter();
        return;
      }

      matchRanges = buildRanges(term);

      if(!matchRanges.length){
        currentMatch = -1;
        updateCounter();
        return;
      }

      if(anchorIndex !== null){
        currentMatch = findBestMatchIndex(effectiveAnchor);
      }else if(keepIndex && currentMatch >= 0){
        currentMatch = Math.min(currentMatch, matchRanges.length - 1);
      }else{
        currentMatch = 0;
      }

      paintMarks(scroll);
      updateCounter();
    }

    function goto(delta){
      if(!matchRanges.length) return;
      currentMatch = (currentMatch + delta) % matchRanges.length;
      if(currentMatch < 0) currentMatch = matchRanges.length - 1;
      paintMarks(true);      // scroll only when navigating
      updateCounter();
    }

    // Editor change:
    // - anchor current match to cursor
    // - DO NOT scroll automatically (so you can edit a specific occurrence)
    editor.on("change", () => {
      setSaved(false);
      updateStats();

      clearTimeout(t);
      t = setTimeout(() => persist(editor.getValue()), 350);

      // Keep the match under the caret (or nearest previous) while typing
      const anchor = editor.indexFromPos(editor.getCursor());
      refreshSearch({ anchorIndex: anchor, scroll: false });
    });

    window.addEventListener("beforeunload", () => {
      const text = editor.getValue();
      sessionStorage.setItem(KEY_SESSION, text);
      localStorage.setItem(KEY_LOCAL, text);
    });

    // Open file
    const openBtn = document.getElementById("openFile");
    const fileInput = document.getElementById("fileInput");

    openBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (event) => {
      const file = event.target.files && event.target.files[0];
      if(!file) return;

      const ok = file.type.match("text.*") || file.name.match(/\.(html|htm|txt|js|css)$/i);
      if(!ok){
        alert("Veuillez s√©lectionner un fichier texte/HTML/JS/CSS.");
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        editor.setValue(String(e.target.result || ""));
        setSaved(false);
        updateStats();

        const base = file.name.replace(/\.(html?|HTML?|txt|js|css)$/i, "");
        localStorage.setItem(KEY_FILENAME, base);
        fileBadge.innerHTML = "Fichier - <strong>" + escapeHTML(base) + "</strong>";

        fileInput.value = "";

        // refresh search without stealing position
        refreshSearch({ keepIndex: false, scroll: false });
      };
      reader.onerror = () => alert("Erreur lors de la lecture du fichier.");
      reader.readAsText(file);
    });

    // Run
    document.getElementById("execute").addEventListener("click", () => {
      const code = editor.getValue();
      if(!code.trim()){
        alert("Veuillez coller du code avant d'ex√©cuter.");
        return;
      }
      const w = window.open("", "_blank");
      if(!w){
        alert("Pop-up bloqu√©e par le navigateur.");
        return;
      }
      w.document.open();
      w.document.write(code);
      w.document.close();
    });

    // Save to file
    document.getElementById("save").addEventListener("click", () => {
      const content = editor.getValue();
      if(!content.trim()){
        alert("Rien √† enregistrer.");
        return;
      }
      const suggested = (localStorage.getItem(KEY_FILENAME) || "script").trim() || "script";
      const fileName = prompt("Nom du fichier (sans extension) :", suggested);
      if(!fileName) return;

      const clean = fileName.replace(/[\\/:*?"<>|]/g, "").trim();
      if(!clean){
        alert("Nom de fichier invalide.");
        return;
      }

      const blob = new Blob([content], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = clean + ".html";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      localStorage.setItem(KEY_FILENAME, clean);
      fileBadge.innerHTML = "Fichier - <strong>" + escapeHTML(clean) + "</strong>";
      persist(content);
    });

    // Reset
    document.getElementById("reset").addEventListener("click", () => {
      if(!confirm("Voulez-vous vraiment tout effacer ? (cela supprime aussi la sauvegarde)")) return;
      editor.setValue("");
      clearHighlights();
      clearPersist();
      currentMatch = -1;
      updateCounter();
      updateStats();
      persistNote.textContent = "Restauration - aucune";
      fileBadge.innerHTML = "Fichier - <strong>(aucun)</strong>";
    });

    // Search input - do NOT affect editor focus
    searchInput.addEventListener("input", () => {
      currentMatch = -1;
      refreshSearch({ keepIndex: false, scroll: false });
    });

    searchInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        goto(e.shiftKey ? -1 : +1);
      }
    });

    nextBtn.addEventListener("click", () => goto(+1));
    prevBtn.addEventListener("click", () => goto(-1));

    // Initial counter
    updateCounter();
  </script>
</body>
</html>
